name: CI
on:
  pull_request:
    types:
      - opened
      - synchronize
    branches:
      - main

permissions:
  checks: write
  pull-requests: write

jobs:
  analyse:
    name: Analysis ğŸ”
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v2
      - name: ğŸ“ Extract flutter version
        id: fvmrc
        # get flutter key from .fvmrc file (file is in json format)
        run: echo "FLUTTER_VERSION=$(jq -r '.flutter' .fvmrc)" >> $GITHUB_OUTPUT
      - name: ğŸš€ Set up Flutter
        uses: subosito/flutter-action@v1
        with:
          flutter-version: ${{ steps.fvmrc.outputs.FLUTTER_VERSION }}
      - name: ğŸ“¦ Get dependencies
        run: flutter pub get
      - name: ğŸ” Analyze code
        continue-on-error: true
        run: flutter analyze --no-pub >> analysis.txt
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4.7.1
        with:
          python-version: '3.10'
      - name: ğŸ“ Construct analysis comment
        run: python .github/workflows/construct_analysis_comment.py analysis.txt ${{ github.event.pull_request.head.sha }} ${{ github.event.number }} comment.txt
      - name: ğŸ’¬ Post analysis comment
        uses: peter-evans/create-or-update-comment@v3.1.0
        with:
          body-path: comment.txt
          issue-number: ${{ github.event.pull_request.number }}
          token: ${{ secrets.PAT }}
      - name: âœ… Annotate analysis results
        uses: invertase/github-action-dart-analyzer@v3
      - name: âŒ Fail if there are errors
        run: |
          if [ -s analysis.txt ]; then
            exit 1
          fi

  Testing:
    name: Testing ğŸ§ª
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v2
      - name: ğŸ“ Extract flutter version
        id: fvmrc
        # get flutter key from .fvmrc file (file is in json format)
        run: echo "FLUTTER_VERSION=$(jq -r '.flutter' .fvmrc)" >> $GITHUB_OUTPUT
      - name: ğŸš€ Set up Flutter
        uses: subosito/flutter-action@v1
        with:
          flutter-version: ${{ steps.fvmrc.outputs.FLUTTER_VERSION }}
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4.7.1
        with:
          python-version: '3.10'
      - name: ğŸ“¦ Get dependencies
        run: flutter pub get
      - name: ğŸ› ï¸ Start Moodle mock server
        uses: mockoon/cli-action@v1
        with:
          data-file: test/mockoon/moodle.json
          port: 6000
      - name: ğŸŒ Start public API mock server
        uses: mockoon/cli-action@v1
        with:
          data-file: test/mockoon/public_api.json
          port: 6008
      - name: ğŸ§ª Start unit tests mock server
        uses: mockoon/cli-action@v1
        with:
          data-file: test/mockoon/unit_tests.json
          port: 3000
      - name: ğŸ—‚ï¸ Start files mock server
        uses: mockoon/cli-action@v1
        with:
          data-file: test/mockoon/files.json
          port: 5000
      - name: ğŸ”„ Run tests
        continue-on-error: true
        run: flutter test --machine > test-results.json
      - name: ğŸ“Š Annotate test results
        uses: dorny/test-reporter@v1.9.1
        id: reporter
        with:
          name: Test Results
          path: test-results.json
          reporter: dart-json
          token: ${{ secrets.PAT }}
      - run: pip install requests
      - name: ğŸ“ Construct test comment
        run: python .github/workflows/construct_unit_test_comment.py ${{ steps.reporter.outputs.url }} ${{ github.event.pull_request.head.sha }} comment.txt
      - name: ğŸ’¬ Post test comment
        uses: peter-evans/create-or-update-comment@v3.1.0
        with:
          body-path: comment.txt
          issue-number: ${{ github.event.pull_request.number }}
          token: ${{ secrets.PAT }}
